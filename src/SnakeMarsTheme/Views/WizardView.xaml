<UserControl
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:SnakeMarsTheme.ViewModels"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit" xmlns:xcad="http://schemas.xceed.com/wpf/xaml/avalondock" x:Class="SnakeMarsTheme.Views.WizardView"
             >

    <UserControl.DataContext>
        <vm:WizardViewModel/>
    </UserControl.DataContext>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="79.62"/>
            <RowDefinition/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- STEP INDICATOR -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="0" Background="{StaticResource BackgroundMediumBrush}" CornerRadius="8" Padding="20,15" Margin="0,0,0,15">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                <Border x:Name="Step1Border" Background="{StaticResource AccentCyanBrush}" CornerRadius="4" Padding="15,8" Margin="5,0">
                    <TextBlock x:Name="Step1Label" Text="1. Configuracion" FontSize="14" Foreground="#000000" FontWeight="Bold"/>
                </Border>
                <Border x:Name="Step2Border" Background="Transparent" CornerRadius="4" Padding="15,8" Margin="5,0">
                    <TextBlock x:Name="Step2Label" Text="2. Fondo" FontSize="14" Foreground="{StaticResource TextSecondaryBrush}"/>
                </Border>
                <Border x:Name="Step3Border" Background="Transparent" CornerRadius="4" Padding="15,8" Margin="5,0">
                    <TextBlock x:Name="Step3Label" Text="3. Widgets" FontSize="14" Foreground="{StaticResource TextSecondaryBrush}"/>
                </Border>
                <Border x:Name="Step4Border" Background="Transparent" CornerRadius="4" Padding="15,8" Margin="5,0">
                    <TextBlock x:Name="Step4Label" Text="4. Guardar" FontSize="14" Foreground="{StaticResource TextSecondaryBrush}"/>
                </Border>
            </StackPanel>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- CONTENT AREA -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="1" Background="{StaticResource BackgroundMediumBrush}" CornerRadius="8">
            <Grid>
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- STEP 1: Configuration -->

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- STEP 2: Background -->

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- STEP 3: Widgets -->

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- STEP 4: Summary -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Grid x:Name="Step1Panel" Margin="30">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="ConfiguraciÃ³n del Tema" FontSize="22" FontWeight="Bold"
                               Foreground="{StaticResource AccentCyanBrush}" Margin="0,0,0,25"/>

                    <Border Grid.Row="1" Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="25">
                        <StackPanel>
                            <!-- Theme Name -->
                            <TextBlock Text="Nombre del Tema" FontWeight="SemiBold" FontSize="13"
                                       Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                            <TextBox Text="{Binding ThemeName, UpdateSourceTrigger=PropertyChanged}" 
                                     Padding="12,10" FontSize="14" Width="350" HorizontalAlignment="Left"/>

                            <!-- Resolution -->
                            <TextBlock Text="ResoluciÃ³n de Pantalla" FontWeight="SemiBold" FontSize="13"
                                       Foreground="{StaticResource TextPrimaryBrush}" Margin="0,25,0,8"/>
                            <ComboBox ItemsSource="{Binding Resolutions}" 
                                      SelectedItem="{Binding SelectedResolution}" 
                                      MaxWidth="400" HorizontalAlignment="Left" Padding="10,8" FontSize="13"/>

                            <!-- Theme Type -->
                            <TextBlock Text="Tipo de Tema" FontWeight="SemiBold" FontSize="13"
                                       Foreground="{StaticResource TextPrimaryBrush}" Margin="0,25,0,12"/>
                            <Border Background="{StaticResource BackgroundMediumBrush}" CornerRadius="6" Padding="15">
                                <StackPanel>
                                    <RadioButton IsChecked="{Binding IsSettingTxtType}" Margin="0,5">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Setting.txt" FontWeight="Bold" Foreground="{StaticResource AccentGreenBrush}"/>
                                            <TextBlock Text=" - Control total sobre widgets (Recomendado)" Foreground="{StaticResource TextSecondaryBrush}"/>
                                        </StackPanel>
                                    </RadioButton>
                                    <RadioButton Margin="0,12,0,5">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="GIF Simple" FontWeight="Bold" Foreground="{StaticResource AccentOrangeBrush}"/>
                                            <TextBlock Text=" - Solo animaciÃ³n bÃ¡sica sin widgets" Foreground="{StaticResource TextSecondaryBrush}"/>
                                        </StackPanel>
                                    </RadioButton>
                                </StackPanel>
                            </Border>

                            <!-- Advanced Tools -->
                            <TextBlock Text="Herramientas Avanzadas" FontWeight="SemiBold" FontSize="13"
                                       Foreground="{StaticResource TextPrimaryBrush}" Margin="0,25,0,8"/>
                             <Button Command="{Binding OpenThemeExtractorCommand}"
                                    HorizontalAlignment="Left" Width="350" Padding="12,10">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="ðŸ“‚" Margin="0,0,10,0"/>
                                    <TextBlock Text="Extraer Recursos de .turtheme (Legacy)"/>
                                </StackPanel>
                            </Button>

                            <!-- Help Text -->
                            <TextBlock Text="ðŸ’¡ Ingresa un nombre y selecciona la resoluciÃ³n para continuar." Margin="0,25,0,0"
                                       Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                            <xcad:AnchorablePaneTitle/>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Grid x:Name="Step2Panel" Visibility="Collapsed" Margin="30">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Seleccionar Fondo" FontSize="22" FontWeight="Bold"
                               Foreground="{StaticResource AccentCyanBrush}" Margin="0,0,0,25"/>

                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="350"/>
                        </Grid.ColumnDefinitions>

                        <!-- Left: Options -->
                        <Border Grid.Column="0" Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="25" Margin="0,0,15,0">
                            <StackPanel>
                                <!-- Background Type Selection -->
                                <TextBlock Text="Tipo de Fondo" FontWeight="SemiBold" FontSize="13"
                                           Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                                <ComboBox ItemsSource="{Binding BackgroundTypes}" 
                                          SelectedItem="{Binding BackgroundType}"
                                          Padding="12,10" FontSize="13" Margin="0,0,0,20"/>

                                <!-- File Selection -->
                                <StackPanel Visibility="{Binding HasTemplates, Converter={StaticResource GlobalBoolToVis}}">
                                    <TextBlock Text="ðŸŽ¬ Plantillas Disponibles" FontWeight="SemiBold" FontSize="13"
                                               Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                                    <ComboBox ItemsSource="{Binding AvailableTemplates}" 
                                              SelectedItem="{Binding SelectedTemplate}"
                                              Padding="12,10" FontSize="13" Margin="0,0,0,20"/>
                                </StackPanel>

                                <TextBlock Text="Seleccionar Archivo" FontWeight="SemiBold" FontSize="13"
                                           Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,12"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox Grid.Column="0" Text="{Binding BackgroundPath}" IsReadOnly="True" Padding="12,10" FontSize="12"/>
                                    <Button Grid.Column="1" Content="ðŸ“ Explorar" Command="{Binding BrowseBackgroundCommand}" 
                                            Margin="10,0,0,0" Padding="15,10"
                                            Background="{StaticResource AccentCyanBrush}" Foreground="#000000"/>
                                </Grid>

                                <!-- Animation Settings (for GIF/Video) -->
                                <Border x:Name="AnimationSettingsPanel" Background="{StaticResource BackgroundMediumBrush}" CornerRadius="6" Padding="15" Margin="0,20,0,0"
                                        Visibility="Visible">
                                    <StackPanel>
                                        <TextBlock Text="âš™ï¸ ConfiguraciÃ³n de AnimaciÃ³n" FontWeight="Bold" 
                                                   Foreground="{StaticResource AccentOrangeBrush}" Margin="0,0,0,12"/>

                                        <!-- FPS Slider -->
                                        <TextBlock Text="FPS (Frames por segundo)" FontSize="12"
                                                   Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,8"/>
                                        <Grid Margin="0,0,0,15">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="80"/>
                                            </Grid.ColumnDefinitions>
                                            <Slider Grid.Column="0" Minimum="5" Maximum="30" Value="{Binding AnimationFPS}"
                                                    VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1" Text="{Binding AnimationFPS, StringFormat=\{0\} FPS}"
                                                       Foreground="{StaticResource AccentCyanBrush}" FontWeight="Bold"
                                                       HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                        </Grid>

                                        <!-- Extract Button -->
                                        <Button Content="âš¡ Extraer Frames" Command="{Binding ExtractFramesCommand}"
                                                Background="{StaticResource AccentOrangeBrush}" Foreground="#000000"
                                                Padding="15,12" FontSize="13" FontWeight="SemiBold"/>

                                        <!-- Extraction Status -->
                                        <TextBlock Text="{Binding ExtractionStatus}" FontSize="11"
                                                   Foreground="{StaticResource AccentCyanBrush}" Margin="0,10,0,0"
                                                   TextWrapping="Wrap"/>

                                        <!-- Frames Count Info -->
                                        <Border Background="{StaticResource BackgroundLightBrush}" CornerRadius="4" Padding="10" Margin="0,10,0,0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="ðŸ“Š Frames:" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,8,0"/>
                                                <TextBlock Text="{Binding ExtractedFramesCount}" FontSize="11" FontWeight="Bold"
                                                           Foreground="{StaticResource AccentGreenBrush}"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>

                                <!-- Help -->
                                <TextBlock Text="ðŸ’¡ Si no seleccionas fondo, se usarÃ¡ un color negro." Margin="0,25,0,0"
                                           Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                            </StackPanel>
                        </Border>

                        <!-- Right: Preview -->
                        <Border Grid.Column="1" Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="15">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <TextBlock Grid.Row="0" Text="VISTA PREVIA" FontWeight="Bold" FontSize="11"
                                           Foreground="{StaticResource AccentCyanBrush}" Margin="0,0,0,10"/>

                                <Border Grid.Row="1" Background="#000000" CornerRadius="6" 
                                        BorderBrush="{StaticResource BorderMediumBrush}" BorderThickness="1">
                                    <Grid>
                                        <TextBlock Text="Sin fondo seleccionado" Foreground="#333333"
                                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        <Image Source="{Binding BackgroundPreview}" Stretch="Uniform"/>
                                    </Grid>
                                </Border>
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Grid x:Name="Step3Panel" Visibility="Collapsed" Margin="25">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="AÃ±adir Widgets" FontSize="22" FontWeight="Bold"
                               Foreground="{StaticResource AccentCyanBrush}" Margin="0,0,0,20"/>

                    <!-- Adaptive Layout Container -->
                    <!-- VERTICAL/SQUARE LAYOUT: Column-based -->
                    <Grid Grid.Row="1" Visibility="{Binding IsHorizontalLayout, Converter={StaticResource GlobalInverseBoolToVis}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="{Binding PreviewContainerWidth}"/>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="200"/>
                        </Grid.ColumnDefinitions>

                        <!-- Preview (LEFT) -->
                        <Border Grid.Column="0" Background="#0D0D0D" CornerRadius="8" Margin="0,0,10,0"
                                BorderBrush="{StaticResource AccentCyanBrush}" BorderThickness="2" Padding="15" ClipToBounds="True">
                            <ScrollViewer x:Name="PreviewScrollViewer" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                <Viewbox x:Name="PreviewViewbox" Stretch="Uniform" MouseWheel="Canvas_MouseWheel">
                                    <Viewbox.LayoutTransform>
                                        <ScaleTransform x:Name="ZoomTransform" ScaleX="1" ScaleY="1"/>
                                    </Viewbox.LayoutTransform>
                                    <Canvas x:Name="WizardCanvas"
                                            Width="{Binding CanvasWidth}"
                                            Height="{Binding CanvasHeight}"
                                            Background="Black"
                                            ClipToBounds="True"
                                            MouseLeftButtonDown="Canvas_MouseDown"
                                            MouseLeftButtonUp="Canvas_MouseUp"
                                            MouseMove="Canvas_MouseMove">

                                        <!-- Background Image -->
                                        <Image Source="{Binding CanvasPreview}"
                                               Width="{Binding CanvasWidth}"
                                               Height="{Binding CanvasHeight}"
                                               Stretch="Fill"
                                               Visibility="{Binding IsVideoBackground, Converter={StaticResource GlobalInverseBoolToVis}}"/>

                                        <!-- Background Video -->
                                        <MediaElement x:Name="WizardVideo"
                                                      Source="{Binding VideoSource}"
                                                      Width="{Binding CanvasWidth}"
                                                      Height="{Binding CanvasHeight}"
                                                      Stretch="Fill"
                                                      LoadedBehavior="Manual"
                                                      UnloadedBehavior="Stop"
                                                      MediaEnded="Video_MediaEnded"
                                                      Visibility="{Binding IsVideoBackground, Converter={StaticResource GlobalBoolToVis}}"/>

                                        <!-- Invisible drag overlay - click to drag widget -->
                                        <ItemsControl ItemsSource="{Binding SelectedWidgets}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <Canvas/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemContainerStyle>
                                                <Style TargetType="{x:Type ContentPresenter}">
                                                    <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                                    <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                                </Style>
                                            </ItemsControl.ItemContainerStyle>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <!-- Border with Background for hit-test -->
                                                    <Border Background="Transparent" Cursor="SizeAll"
                                                            MouseLeftButtonDown="Widget_MouseDown">
                                                        <TextBlock Text="{Binding DisplayText}" 
                                                                   FontSize="{Binding FontSize}"
                                                                   FontFamily="{Binding Font}"
                                                                   Foreground="Transparent"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Canvas>
                                </Viewbox>
                            </ScrollViewer>
                        </Border>

                        <!-- Widgets List (CENTER) -->
                        <StackPanel Grid.Column="1" Margin="0,0,10,0">
                            <!-- Disponibles -->
                            <Border Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="10" Margin="0,0,0,5">
                                <StackPanel>
                                    <TextBlock Text="DISPONIBLES" Foreground="{StaticResource AccentCyanBrush}" 
                                               FontSize="10" FontWeight="Bold" Margin="0,0,0,8"/>
                                    <ComboBox ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}" 
                                              Margin="0,0,0,8" Padding="6,4" FontSize="11"/>
                                    <ListBox ItemsSource="{Binding AvailableWidgets}" SelectedItem="{Binding SelectedAvailableWidget}"
                                             Height="180" DisplayMemberPath="Name" Padding="4" FontSize="11"/>
                                </StackPanel>
                            </Border>

                            <!-- Add/Remove Buttons -->
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,8">
                                <Button Content="â–¶" Command="{Binding AddWidgetCommand}" Margin="5,0" Padding="10,6"
                                        Background="{StaticResource AccentGreenBrush}" Foreground="#000000" FontWeight="Bold" FontSize="12"/>
                                <Button Content="â—€" Command="{Binding RemoveWidgetCommand}" Margin="5,0" Padding="10,6"
                                        Background="{StaticResource AccentRedBrush}" Foreground="#FFFFFF" FontWeight="Bold" FontSize="12"/>
                            </StackPanel>

                            <!-- En Tema -->
                            <Border Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="10" Margin="0,5,0,0">
                                <StackPanel>
                                    <TextBlock Text="EN TEMA" Foreground="{StaticResource AccentGreenBrush}" 
                                               FontSize="10" FontWeight="Bold" Margin="0,0,0,8"/>
                                    <ListBox x:Name="SelectedWidgetsListBox" ItemsSource="{Binding SelectedWidgets}" 
                                             SelectedItem="{Binding SelectedThemeWidget, Mode=TwoWay}"
                                             Height="200" DisplayMemberPath="Display" Padding="4" FontSize="11"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Properties + Info (RIGHT) -->
                        <StackPanel Grid.Column="2">
                            <!-- Propiedades - DIRECT BINDING to SelectedThemeWidget -->
                            <Border Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="12" Margin="0,0,0,10">
                                <StackPanel IsEnabled="{Binding SelectedThemeWidget, Converter={StaticResource GlobalNotNullToBool}}">
                                    <TextBlock Text="PROPIEDADES" FontWeight="Bold" Foreground="{StaticResource AccentCyanBrush}" 
                                               FontSize="10" Margin="0,0,0,10"/>
                                    <Grid Margin="0,0,0,6">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0" Margin="0,0,4,0">
                                            <TextBlock Text="X" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,0,0,3"/>
                                            <xctk:IntegerUpDown Value="{Binding SelectedThemeWidget.X, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                                Minimum="0" Maximum="2000" Increment="1"
                                                                Padding="6,2" FontSize="11"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Margin="4,0,0,0">
                                            <TextBlock Text="Y" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,0,0,3"/>
                                            <xctk:IntegerUpDown Value="{Binding SelectedThemeWidget.Y, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                                Minimum="0" Maximum="2000" Increment="1"
                                                                Padding="6,2" FontSize="11"/>
                                        </StackPanel>
                                    </Grid>
                                    <TextBlock Text="TamaÃ±o" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,6,0,3"/>
                                    <xctk:IntegerUpDown Value="{Binding SelectedThemeWidget.FontSize, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                        Minimum="8" Maximum="200" Increment="2"
                                                        Padding="6,2" FontSize="11"/>
                                    <TextBlock Text="Fuente" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,6,0,3"/>
                                    <ComboBox ItemsSource="{Binding AvailableFonts}" SelectedItem="{Binding SelectedThemeWidget.Font, Mode=TwoWay}" Padding="6,4" FontSize="11"/>
                                    <TextBlock Text="Color" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,6,0,3"/>
                                    <xctk:ColorPicker SelectedColor="{Binding SelectedThemeWidget.ColorMedia, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      DisplayColorAndName="True" ShowStandardColors="True" 
                                                      ShowRecentColors="True" Height="28"/>
                                    <Button Content="â†» Refrescar Preview" Command="{Binding RefreshPreviewCommand}" Margin="0,10,0,0"
                                            Background="{StaticResource AccentCyanBrush}" Foreground="#000000" Padding="8,6" FontWeight="SemiBold" FontSize="11"/>
                                </StackPanel>
                            </Border>

                            <!-- Info -->
                            <Border Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="12">
                                <StackPanel>
                                    <TextBlock Text="INFO" FontWeight="Bold" Foreground="{StaticResource AccentOrangeBrush}" 
                                               FontSize="10" Margin="0,0,0,8"/>
                                    <TextBlock Text="{Binding CanvasInfo}" Foreground="{StaticResource TextSecondaryBrush}" 
                                               FontSize="10" TextWrapping="Wrap"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Grid>

                    <!-- HORIZONTAL LAYOUT: Row-based -->
                    <Grid Grid.Row="1" Visibility="{Binding IsHorizontalLayout, Converter={StaticResource GlobalBoolToVis}}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- ROW 1: Controls (Widgets + Props + Info) -->
                        <Grid Grid.Row="0" Margin="0,0,0,15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="300"/>
                                <ColumnDefinition Width="400"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Widgets Vertical Stack -->
                            <StackPanel Grid.Column="0" Margin="0,0,10,0">
                                <Border Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="10" Margin="0,0,0,5">
                                    <StackPanel>
                                        <TextBlock Text="DISPONIBLES" Foreground="{StaticResource AccentCyanBrush}" 
                                                   FontSize="10" FontWeight="Bold" Margin="0,0,0,8"/>
                                        <ComboBox ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}" 
                                                  Margin="0,0,0,8" Padding="6,4" FontSize="11"/>
                                        <ListBox ItemsSource="{Binding AvailableWidgets}" SelectedItem="{Binding SelectedAvailableWidget}"
                                                 Height="80" DisplayMemberPath="Name" Padding="4" FontSize="11"/>
                                    </StackPanel>
                                </Border>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,5">
                                    <Button Content="â–¶" Command="{Binding AddWidgetCommand}" Margin="5,0" Padding="10,6"
                                            Background="{StaticResource AccentGreenBrush}" Foreground="#000000" FontWeight="Bold" FontSize="12"/>
                                    <Button Content="â—€" Command="{Binding RemoveWidgetCommand}" Margin="5,0" Padding="10,6"
                                            Background="{StaticResource AccentRedBrush}" Foreground="#FFFFFF" FontWeight="Bold" FontSize="12"/>
                                </StackPanel>
                                <Border Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="10" Margin="0,5,0,0">
                                    <StackPanel>
                                        <TextBlock Text="EN TEMA" Foreground="{StaticResource AccentGreenBrush}" 
                                                   FontSize="10" FontWeight="Bold" Margin="0,0,0,8"/>
                                        <ListBox ItemsSource="{Binding SelectedWidgets}" SelectedItem="{Binding SelectedThemeWidget}"
                                                 Height="100" DisplayMemberPath="Display" Padding="4" FontSize="11"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                            <!-- Properties -->
                            <Border Grid.Column="1" Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="15" Margin="0,0,10,0">
                                <StackPanel>
                                    <TextBlock Text="PROPIEDADES" FontWeight="Bold" Foreground="{StaticResource AccentCyanBrush}" 
                                               FontSize="10" Margin="0,0,0,10"/>
                                    <Grid Margin="0,0,0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                            <TextBlock Text="PosiciÃ³n X" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,0,0,3"/>
                                            <TextBox Text="{Binding WidgetX, UpdateSourceTrigger=PropertyChanged}" Padding="6,4" FontSize="11"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Margin="5,0,0,0">
                                            <TextBlock Text="PosiciÃ³n Y" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,0,0,3"/>
                                            <TextBox Text="{Binding WidgetY, UpdateSourceTrigger=PropertyChanged}" Padding="6,4" FontSize="11"/>
                                        </StackPanel>
                                    </Grid>
                                    <TextBlock Text="TamaÃ±o Fuente" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,0,0,3"/>
                                    <TextBox Text="{Binding WidgetFontSize, UpdateSourceTrigger=PropertyChanged}" Padding="6,4" FontSize="11"/>
                                    <TextBlock Text="Fuente" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,6,0,3"/>
                                    <ComboBox ItemsSource="{Binding AvailableFonts}" SelectedItem="{Binding WidgetFont}" Padding="6,4" FontSize="11"/>
                                    <TextBlock Text="Color" Foreground="{StaticResource TextSecondaryBrush}" FontSize="9" Margin="0,6,0,3"/>
                                    <ComboBox ItemsSource="{Binding AvailableColors}" SelectedItem="{Binding WidgetColor}" Padding="6,4" FontSize="11"/>
                                    <Button Content="âœ“ Aplicar Cambios" Command="{Binding ApplyWidgetChangesCommand}" Margin="0,10,0,0"
                                            Background="{StaticResource AccentCyanBrush}" Foreground="#000000" Padding="10,6" FontWeight="SemiBold" FontSize="11"/>
                                </StackPanel>
                            </Border>

                            <!-- Info -->
                            <Border Grid.Column="2" Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="15">
                                <StackPanel>
                                    <TextBlock Text="INFO" FontWeight="Bold" Foreground="{StaticResource AccentOrangeBrush}" 
                                               FontSize="10" Margin="0,0,0,10"/>
                                    <TextBlock Text="{Binding CanvasInfo}" Foreground="{StaticResource TextSecondaryBrush}" 
                                               FontSize="11" TextWrapping="Wrap"/>
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- ROW 2: Preview FULL WIDTH - INTERACTIVE CANVAS -->
                        <Border Grid.Row="1" Background="#0D0D0D" CornerRadius="8"
                                BorderBrush="{StaticResource AccentCyanBrush}" BorderThickness="2" Padding="15">
                            <Viewbox x:Name="PreviewViewboxHorizontal" Stretch="Uniform" MouseWheel="Canvas_MouseWheel">
                                <Viewbox.RenderTransform>
                                    <ScaleTransform x:Name="ZoomTransformHorizontal" ScaleX="1" ScaleY="1"/>
                                </Viewbox.RenderTransform>
                                <Canvas Width="{Binding CanvasWidth}"
                                        Height="{Binding CanvasHeight}"
                                        Background="Black"
                                        ClipToBounds="True"
                                        MouseLeftButtonDown="Canvas_MouseDown"
                                        MouseLeftButtonUp="Canvas_MouseUp"
                                        MouseMove="Canvas_MouseMove">

                                    <!-- Same Canvas content as above -->
                                    <Image Source="{Binding CanvasPreview}"
                                           Width="{Binding CanvasWidth}"
                                           Height="{Binding CanvasHeight}"
                                           Stretch="Fill"
                                           Visibility="{Binding IsVideoBackground, Converter={StaticResource GlobalInverseBoolToVis}}"/>

                                    <MediaElement Source="{Binding VideoSource}"
                                                  Width="{Binding CanvasWidth}"
                                                  Height="{Binding CanvasHeight}"
                                                  Stretch="Fill"
                                                  LoadedBehavior="Manual"
                                                  UnloadedBehavior="Stop"
                                                  MediaEnded="Video_MediaEnded"
                                                  Visibility="{Binding IsVideoBackground, Converter={StaticResource GlobalBoolToVis}}"/>

                                    <!-- Invisible drag overlay - click to drag widget -->
                                    <ItemsControl ItemsSource="{Binding SelectedWidgets}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="{x:Type ContentPresenter}">
                                                <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                                <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="Transparent" Cursor="SizeAll"
                                                        MouseLeftButtonDown="Widget_MouseDown">
                                                    <TextBlock Text="{Binding DisplayText}" 
                                                               FontSize="{Binding FontSize}"
                                                               FontFamily="{Binding Font}"
                                                               Foreground="Transparent"/>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Canvas>
                            </Viewbox>
                        </Border>
                    </Grid>
                </Grid>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Grid x:Name="Step4Panel" Visibility="Collapsed" Margin="30">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Resumen del Tema" FontSize="22" FontWeight="Bold"
                               Foreground="{StaticResource AccentCyanBrush}" Margin="0,0,0,25"/>

                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="350"/>
                        </Grid.ColumnDefinitions>

                        <!-- Summary Details -->
                        <Border Grid.Column="0" Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="25" Margin="0,0,15,0">
                            <StackPanel>
                                <TextBlock Text="CONFIGURACIÃ“N FINAL" FontWeight="Bold" FontSize="12"
                                           Foreground="{StaticResource AccentCyanBrush}" Margin="0,0,0,15"/>
                                <Border Background="#000000" CornerRadius="6" Padding="20">
                                    <TextBlock Text="{Binding Summary}" FontFamily="Consolas" FontSize="13"
                                               Foreground="{StaticResource AccentGreenBrush}" TextWrapping="Wrap"/>
                                </Border>

                                <TextBlock Margin="0,20,0,0" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" TextWrapping="Wrap"><Run Text="âœ“ " Foreground="{StaticResource AccentGreenBrush}"/><Run Text=" "/><Run Text="Haz clic en "/><Run Text=" "/><Run Text="'Crear Tema'" FontWeight="Bold"/><Run Text=" "/><Run Text=" para guardar tu tema y generar los archivos necesarios."/></TextBlock>
                            </StackPanel>
                        </Border>

                        <!-- What will be created -->
                        <Border Grid.Column="1" Background="{StaticResource BackgroundLightBrush}" CornerRadius="8" Padding="20">
                            <StackPanel>
                                <TextBlock Text="ARCHIVOS A GENERAR" FontWeight="Bold" FontSize="12"
                                           Foreground="{StaticResource AccentOrangeBrush}" Margin="0,0,0,15"/>
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,8">
                                        <TextBlock Text="ðŸ“„" FontSize="16" Margin="0,0,10,0"/>
                                        <StackPanel>
                                            <TextBlock Text="Setting.txt" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="SemiBold"/>
                                            <TextBlock Text="ConfiguraciÃ³n de widgets" Foreground="{StaticResource TextSecondaryBrush}" FontSize="11"/>
                                        </StackPanel>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,8">
                                        <TextBlock Text="ðŸ–¼ï¸" FontSize="16" Margin="0,0,10,0"/>
                                        <StackPanel>
                                            <TextBlock Text="back.png" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="SemiBold"/>
                                            <TextBlock Text="Imagen de fondo" Foreground="{StaticResource TextSecondaryBrush}" FontSize="11"/>
                                        </StackPanel>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,8">
                                        <TextBlock Text="ðŸ“·" FontSize="16" Margin="0,0,10,0"/>
                                        <StackPanel>
                                            <TextBlock Text="demo.png" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="SemiBold"/>
                                            <TextBlock Text="Vista previa del tema" Foreground="{StaticResource TextSecondaryBrush}" FontSize="11"/>
                                        </StackPanel>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,8">
                                        <TextBlock Text="ðŸ“‹" FontSize="16" Margin="0,0,10,0"/>
                                        <StackPanel>
                                            <TextBlock Text="theme.json" Foreground="{StaticResource TextPrimaryBrush}" FontWeight="SemiBold"/>
                                            <TextBlock Text="Metadatos del tema" Foreground="{StaticResource TextSecondaryBrush}" FontSize="11"/>
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Grid>
            </Grid>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- NAVIGATION BAR -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="2" Background="{StaticResource BackgroundMediumBrush}" CornerRadius="8" Padding="20,15" Margin="0,15,0,0">
            <Grid>
                <Button x:Name="BtnBack" Content="â—€ Anterior" HorizontalAlignment="Left" Click="BtnBack_Click" 
                        Padding="20,10" FontWeight="SemiBold" Margin="229,0,0,0"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button x:Name="BtnNext" Content="Siguiente â–¶" Click="BtnNext_Click"
                            Background="{StaticResource AccentCyanBrush}" Foreground="#000000" 
                            Padding="20,10" FontWeight="SemiBold"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
